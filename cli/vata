#!/usr/bin/env python3
import subprocess
import os
import sys
import argparse


VATA_CODE_NAME='vata-code'



###########################################
def find_vata_path():
    '''find_vata_path() -> string

Finds the path to the vata-code executable.
'''
    dirname, filename = os.path.split(sys.argv[0])
    vata_code_dirname = os.path.join(dirname, '..' , 'build', 'cli')
    vata_path = os.path.join(vata_code_dirname, VATA_CODE_NAME)
    os.path.isfile(vata_path)
    return vata_path


###########################################
def get_vata_version():
    '''get_vata_version() -> string

Retrieves the version of libVATA.
'''
    result = ''
    result += call_vata_code(['-v'])
    return result


###########################################
def call_vata_code(params=None, input=None):
    '''call_vata_code([params], input=None) -> str

Calls vata-code with the given 'params' and 'input'.  Input is fed into
vata-code on STDIN.  The string from STDOUT is returned.
'''
    command = [VATA_PATH]
    if params:
        command += params

    compl_proc = subprocess.run(command, input=input,
        universal_newlines=True, stdout=subprocess.PIPE)
    compl_proc.check_returncode()  # raises an exception if non-0
    return compl_proc.stdout


###########################################
def create_code_str(cmds):
    '''create_code_str(cmds) -> string

Creates a @CODE string in the .vtf format using 'cmds' as the commands to execute.
'''
    header = \
        '# Generated by libVATA2 CLI interface\n' \
        '\n' \
        '@CODE\n'
    return header + cmds


###########################################
def errprint(str):
    '''errprint(str) -> ()

Prints onto stderr.
'''
    print('error: ' + str, file=sys.stderr)


###########################################
def check_num_params(expected, provided):
    '''check_num_params(expected, provided) -> ()

Raises an exception if 'expected' != 'provided'.
'''
    if expected != provided:
        raise Exception('Number of provided parameters (' + str(provided) + \
            ') does not match the number of expected (' + str(expected) + ')')

###########################################
def run_main(args):
    '''run_main(args) -> ()

Runs the main program according to the arguments obtained from the parser.
'''
    if args.oper == 'load':
        check_num_params(1, len(args.inputs))
        cmds = '(load_aut "' + args.inputs[0] + '")'
    elif args.oper == 'union':
        check_num_params(2, len(args.inputs))
        cmds = '(union (load_aut "' + args.inputs[0] + '") (load_aut "' + args.inputs[1] + '"))'
    elif args.oper == 'isect':
        check_num_params(2, len(args.inputs))
        cmds = '(isect (load_aut "' + args.inputs[0] + '") (load_aut "' + args.inputs[1] + '"))'
    elif args.oper == 'empty':
        check_num_params(1, len(args.inputs))
        cmds = '(is_empty (load_aut "' + args.inputs[0] + '"))'
    elif args.oper == 'univ':
        check_num_params(1, len(args.inputs))
        cmds = '(is_univ (load_aut "' + args.inputs[0] + '"))'
    elif args.oper == 'incl':
        check_num_params(2, len(args.inputs))
        cmds = '(is_incl (load_aut "' + args.inputs[0] + '") (load_aut "' + args.inputs[1] + '"))'
    elif args.oper == 'eq':
        check_num_params(2, len(args.inputs))
        cmds = '(is_eq (load_aut "' + args.inputs[0] + '") (load_aut "' + args.inputs[1] + '"))'
    else:
        assert False    # should never get here

    assert cmds
    cmds = 'res = ' + cmds + '\n(print res)\n';
    code_str = create_code_str(cmds)
    res = call_vata_code(input=code_str)
    print(res)


###########################################
if __name__ == '__main__':
    VATA_PATH = find_vata_path()
    CLI_OPERATIONS = ['load', 'isect', 'union', 'empty', 'univ', 'incl', 'eq']
    vata_version_str = get_vata_version()

    parser = argparse.ArgumentParser(description='User interface to libVATA2')
    parser.add_argument('oper', metavar='op', choices=CLI_OPERATIONS,
                        help='operation to be performed (one of {' +
                        ', '.join(CLI_OPERATIONS) + '})')

    parser.add_argument('inputs', metavar='AUT', nargs='*',
                        help='files with input automata in the .vtf format')

    parser.add_argument('-v', '--version', action='version', version=vata_version_str)

    args = parser.parse_args()

    try:
        run_main(args)
    except Exception as ex:
        errprint(str(ex))
